<?php
/**
 * @file vc.module
 */

/**
 * Register auto loader.
 */
spl_autoload_register('vc_autoload');

/**
 * Autoloader.
 */
function vc_autoload($class) {
  if (strpos($class, 'Drupal\\') === 0) {
    return vc_autoload_namespace($class);
  }
  return vc_autoload_class($class);
}

$lazy_hook =  drupal_realpath(Vc_Lazy_Hook::DUMP_FILE);
if (file_exists($lazy_hook)) {
  include_once $lazy_hook;
}

/**
 *
 * @param type $class
 */
function vc_autoload_namespace($class) {
  $suffix = str_replace('\\', '/', $class) . '.php';
  foreach (vc_get_module_apis() as $module => $info) {
    if (strpos($suffix, "Drupal/{$module}/") !== FALSE) {
      $prefix = DRUPAL_ROOT . '/' . drupal_get_path('module', $module);
      $file = "{$prefix}/lib/{$suffix}";
      if (file_exists($file)) {
        require_once $file;
      }
    }
  }
}

function vc_autoload_class($class) {
  foreach (vc_get_module_apis() as $module => $info) {
    $_module = str_replace('_', ' ', $module);
    $_module = ucwords($_module);
    $_module = str_replace(' ', '', $_module);
    $path  = DRUPAL_ROOT . '/' . drupal_get_path('module', $module) . '/lib/';

    if ($_module === $class) {
      $path .= "{$class}.php";
    }
    else {
      // Find sub, remove module prefix.
      if (strpos($class, '_') !== FALSE) {
        $sub = explode('_', $class);
        array_shift($sub);
        $sub = implode('/', $sub);
      }
      else {
        $sub = substr($class, strlen($_module));
      }
      $path .= "{$sub}.php";
    }

    if (file_exists($path)) {
      include_once $path;
    }
  }
}

/**
 * Implements hook_init().
 */
function vc_init() {}

/**
 * Wrapper function to work with configuration value of a module.
 *
 * @see README.txt > Configuration System
 */
function vc_conf($path) {
  static $config;

  if (!$config) {
    $config = new VcConfig($path);
  }

  return $config;
}

/**
 * Get modules support vc.
 */
function vc_get_module_apis($api = 'vc', $reset = FALSE) {
  if ($reset) {
    $cache = &drupal_static('ctools_plugin_api_info');
    if (isset($cache['vc'][$api])) {
      unset($cache['vc'][$api]);
    }
  }
  ctools_include('plugins');
  return ctools_plugin_api_info('vc', $api, '1.0', '1.0');
}

/**
 * Tell ctools our hook name.
 */
function vc_ctools_plugin_api_hook_name() {
  return 'vc_api';
}

/**
 * Implements vc.module\hook_vc_api().
 */
function vc_vc_api() {
  return array('version' => '1.0');
}

/**
 * Cache wrapper function
 */
function vc_cache($options = array(), $callback) {
  $args = func_get_args();
  unset($args[0], $args[1]);

  $cache_id = 'vc:cache:';
  $cache_id = substr(md5(serialize($callback) . serialize($args)), 0, 10);

  $bin = isset($options['bin']) ? $options['bin'] : 'cache';
  $expire = isset($options['expire']) ? $options['expire'] : CACHE_PERMANENT;

  if ($cache = cache_get($cache_id, $bin)) {
    return $cache->data;
  }

  $result = call_user_func_array($callback, $args);

  cache_set($cache_id, $result, $bin, $expire);
  return $result;
}

/**
 * Build lazy content.
 *
 * @param string $path
 * @return type
 */
function vc_content($path) {
  return Vc_Lazy_Content::build($path);
}
